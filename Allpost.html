<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>All Posts | Postify</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-slate-950 text-slate-200 min-h-screen">

<header class="sticky top-0 z-10 bg-slate-900/70 backdrop-blur border-b border-slate-800 p-4 flex justify-between items-center">
  <h1 class="text-2xl font-extrabold bg-gradient-to-r from-pink-500 to-violet-500 bg-clip-text text-transparent">All Posts</h1>
  <a href="post.html" class="text-sm px-3 py-1 rounded-full bg-slate-800 text-slate-300 hover:bg-slate-700">
    Create New Post
  </a>
</header>

<main class="max-w-6xl mx-auto p-4 sm:p-6">
  <div id="posts" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3"></div>
</main>

<script>
// ðŸ”¹ Supabase credentials
const SUPABASE_URL = "https://eyyoigiytzhbtcwqvooa.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5eW9pZ2l5dHpoYnRjd3F2b29hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NDE0OTUsImV4cCI6MjA3MDUxNzQ5NX0.2LNSR60X9QXh2oih_bmnP31iKo5pV82-0cPa06J2L8k";

// ðŸ”¹ Supabase client
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const postsDiv = document.getElementById("posts");

// ðŸ”¹ Fetch posts
async function fetchPosts() {
  const { data, error } = await client
    .from("posts")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    console.error(error);
    return Swal.fire({ icon: 'error', title: 'Oops!', text: error.message });
  }

  postsDiv.innerHTML = "";

  data.forEach(post => {
    postsDiv.innerHTML += `
      <div class="bg-slate-900 rounded-3xl shadow p-4 transition hover:-translate-y-1 hover:shadow-violet-500/20 relative">

        <p class="text-sm text-slate-400 mb-1">By: ${post.user_name || 'Anonymous'}</p>
        <h2 class="text-lg font-bold">${post.title}</h2>
        <p class="text-sm text-slate-300 mt-1">${post.content}</p>
        ${post.image_url ? `<img src="${post.image_url}" class="w-full h-40 object-cover mt-2 rounded-xl">` : ""}

        <!-- Buttons -->
        <div class="flex justify-end gap-2 mt-3">
          <button onclick="editPost(${post.id}, '${post.title.replace(/'/g, "\\'")}', '${post.content.replace(/'/g, "\\'")}', '${(post.user_name || 'Anonymous').replace(/'/g, "\\'")}')"
            class="px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/40 font-semibold text-sm">
            Edit
          </button>
          <button onclick="deletePost(${post.id})"
            class="px-3 py-1 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/40 font-semibold text-sm">
            Delete
          </button>
        </div>
      </div>
    `;
  });
}

fetchPosts();

// ðŸ”¹ Delete Post with SweetAlert
async function deletePost(id) {
  try {
    const result = await Swal.fire({
      title: 'Are you sure?',
      text: "This post will be permanently deleted!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Yes, delete it!'
    });

    if (result.isConfirmed) {
      const { error } = await client.from("posts").delete().eq("id", id);
      if (error) throw error;

      await Swal.fire({
        icon: 'success',
        title: 'Deleted!',
        text: 'Your post has been deleted.',
        timer: 1500,
        showConfirmButton: false
      });

      fetchPosts(); // refresh posts
    }
  } catch (err) {
    console.error(err);
    Swal.fire({ icon: 'error', title: 'Oops!', text: err.message || 'Something went wrong' });
  }
}

// ðŸ”¹ Edit Post info popup (optional)
function editPost(id, title, content, user_name) {
  Swal.fire({
    icon: 'info',
    title: 'Editing Post',
    text: `You are editing: "${title}" by ${user_name}`,
    timer: 1800,
    showConfirmButton: false
  });

  // Redirect to post.html with query parameter for editing
  window.location.href = `post.html?id=${id}`;
}

</script>
</body>
</html>
