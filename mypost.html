<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>My Posts | Postify</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
/* üåà Background blobs */
.blob{
  position:absolute;
  width:420px;
  height:420px;
  border-radius:50%;
  filter:blur(150px);
  opacity:.5;
  animation:float 14s infinite alternate ease-in-out;
}
.blob.pink{background:#ec4899;top:-120px;left:-120px}
.blob.violet{background:#8b5cf6;bottom:-120px;right:-120px;animation-delay:2s}

@keyframes float{
  from{transform:translate(0,0)}
  to{transform:translate(40px,-40px)}
}

/* ‚ú® Card animation */
.post-card{
  animation:fadeUp .6s ease forwards;
}
@keyframes fadeUp{
  from{opacity:0;transform:translateY(30px) scale(.97)}
  to{opacity:1;transform:translateY(0) scale(1)}
}

/* üì± Mobile polish */
@media(max-width:640px){
  .blob{opacity:.35}
}
</style>
</head>

<body class="relative bg-gradient-to-br from-slate-950 via-slate-900 to-black text-slate-200 min-h-screen overflow-x-hidden">

<!-- üåà Background -->
<div class="blob pink"></div>
<div class="blob violet"></div>

<!-- üîù NAVBAR -->
<header class="sticky top-0 z-20 bg-slate-900/70 backdrop-blur-xl border-b border-slate-800">
  <div class="max-w-7xl mx-auto px-3 sm:px-4 py-2 flex justify-between items-center">

    <h1 class="text-xl sm:text-2xl font-extrabold bg-gradient-to-r from-pink-500 to-violet-500 bg-clip-text text-transparent">
      Postify
    </h1>

    <div class="flex items-center gap-2 sm:gap-3">
      <a href="post.html"
         class="text-xs sm:text-sm px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700 transition">
        + Create
      </a>

      <a href="Allpost.html"
         class="hidden sm:block text-sm px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700 transition">
        Explore
      </a>

      <div id="showImg" class="hidden sm:flex items-center gap-2"></div>

      <button id="logoutBtn"
        class="text-xs sm:text-sm px-3 py-1.5 rounded-full bg-red-600 hover:bg-red-500 transition">
        Logout
      </button>
    </div>
  </div>
</header>

<!-- üß± POSTS -->
<main class="max-w-7xl mx-auto px-3 sm:px-4 py-4 sm:py-6 relative z-10">
  <div id="posts"
    class="grid gap-4 sm:gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
  </div>
</main>

<!-- Edit Modal -->
<div id="editModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center">
  <div class="bg-slate-900 rounded-2xl shadow-2xl p-6 w-full max-w-md transform scale-75 opacity-0 transition-all duration-300 ease-in-out">
    
    <h2 class="text-2xl font-bold text-white mb-4 text-center">Edit Post ‚úèÔ∏è</h2>
    
    <input id="modal-title" type="text" placeholder="Post Title"
      class="w-full p-3 mb-3 rounded-xl bg-slate-800 border border-slate-700 text-white focus:ring-2 focus:ring-violet-500 outline-none">
    
    <textarea id="modal-content" rows="4" placeholder="Post Content"
      class="w-full p-3 mb-3 rounded-xl bg-slate-800 border border-slate-700 text-white focus:ring-2 focus:ring-violet-500 outline-none"></textarea>
    
    <input type="file" id="modal-image" accept="image/*"
      class="w-full text-sm file:bg-slate-700 file:border-0 file:rounded-lg file:px-4 file:py-1 file:text-white mb-3">
    
    <img id="modal-prev-img" class="w-full rounded-xl mb-3 hidden object-cover max-h-52 border border-slate-700 shadow-sm">
    
    <div class="flex gap-3 mt-2">
      <button id="modal-update-btn"
        class="flex-1 py-2 rounded-xl bg-gradient-to-r from-pink-500 to-violet-600 hover:opacity-90 text-white font-semibold transition active:scale-95">
        Update
      </button>
      <button id="modal-cancel-btn"
        class="flex-1 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-white font-semibold transition active:scale-95">
        Cancel
      </button>
    </div>
  </div>
</div>




<script>
  // üîπ Supabase credentials
const SUPABASE_URL = "https://eyyoigiytzhbtcwqvooa.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5eW9pZ2l5dHpoYnRjd3F2b29hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NDE0OTUsImV4cCI6MjA3MDUxNzQ5NX0.2LNSR60X9QXh2oih_bmnP31iKo5pV82-0cPa06J2L8k";

// üîπ Create Supabase client
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const postsDiv = document.getElementById("posts");
const logoutBtn = document.getElementById("logoutBtn");
let currentUser = null;
const showImg = document.getElementById("showImg");


// ‚úÖ Show Profile Image + Email
async function showProfileImg() {
 
  if (!showImg) return;

  try {
    const { data: getUserData, error: getErr } = await client.auth.getUser();
    if (getErr) throw getErr;

    const userId = getUserData.user.id;

    const { data: fetchData, error: fetchErr } = await client
      .from('all-users-data')
      .select('*')
      .eq('user_id', userId)
      .single();
    if (fetchErr) {
      throw fetchErr;
    }
    else{
       showImg.innerHTML = `
      <div class="flex items-center gap-2">
        <span class="text-white font-bold">${getUserData.user.email}</span>
        <img src="${fetchData.profile_img}" 
             class="rounded-full shadow-lg" 
             style="width:40px; height:40px;" 
             alt="profile" />
      </div>
    `;
    }
console.log(fetchData.profile_img);

    const profileImg = fetchData.profile_img || "https://via.placeholder.com/45";
    const email = fetchData.email || getUserData.user.email;

   
  } catch (err) {
    console.error("Error fetching profile:", err.message);
  }
}

// ‚úÖ Check login
async function checkUser(){
  const { data:{ session } } = await client.auth.getSession();
  if(!session){
    Swal.fire({ icon:'info', title:'Please login', timer:1500, showConfirmButton:false });
    setTimeout(()=>window.location.href="index.html",1500);
    return;
  }
  currentUser = session.user;
  showProfileImg(); // call profile after login check
  fetchPosts();
}

// ‚úÖ Format datetime
function formatDateTime(dateString){
  return new Date(dateString).toLocaleString(undefined,{
    year:'numeric', month:'short', day:'numeric',
    hour:'2-digit', minute:'2-digit'
  });
}

// ‚úÖ Fetch posts
async function fetchPosts(){
  const { data, error } = await client.from("posts")
    .select("*")
    .eq("user_id", currentUser.id)
    .order("created_at",{ ascending:false });

  if(error) return Swal.fire({ icon:'error', title:'Oops!', text:error.message });

  postsDiv.innerHTML="";
  if(!data || data.length===0){
    postsDiv.innerHTML=`<p class="text-center text-slate-400 col-span-full mt-6">You have no posts yet.</p>`;
    return;
  }

  data.forEach(post=>{
    const createdAt = post.created_at ? formatDateTime(post.created_at) : '';
    postsDiv.innerHTML+=`
      <div class="bg-slate-900 rounded-3xl shadow-lg p-5 hover:scale-105 transform transition duration-300 ease-in-out border border-slate-800">
        <h2 class="text-lg font-bold text-white line-clamp-2">${post.title}</h2>
        <p class="text-xs text-slate-400 mt-1">${createdAt}</p>
        <p class="text-sm text-slate-300 mt-3 line-clamp-4">${post.content}</p>
        ${post.image_url ? `
          <img src="${post.image_url}" 
               class="w-full h-48 sm:h-40 object-cover rounded-2xl mt-4 border border-slate-700 shadow-sm">
        ` : ""}
        <div class="flex gap-3 mt-4">
          <button
  onclick="editPost('${post.id}','${post.title}','${post.content}','${post.image_url||""}')"
  class="flex-1 text-xs font-semibold px-3 py-2 rounded-xl
         bg-blue-500/90 hover:bg-blue-500 text-white
         transition active:scale-95">
  Edit
</button>

         <button
  onclick="deletePost('${post.id}')"
  class="flex-1 text-xs font-semibold px-3 py-2 rounded-xl
         bg-rose-500/90 hover:bg-rose-500 text-white
         transition active:scale-95">
  Delete
</button>

        </div>
      </div>
    `;
  });
}

const editModal = document.getElementById("editModal");
const modalTitle = document.getElementById("modal-title");
const modalContent = document.getElementById("modal-content");
const modalImage = document.getElementById("modal-image");
const modalPrevImg = document.getElementById("modal-prev-img");
const modalUpdateBtn = document.getElementById("modal-update-btn");
const modalCancelBtn = document.getElementById("modal-cancel-btn");

let currentEditId = null;
let oldImageUrl = "";

// Open modal in center
window.editPost = function(postId, title, content, imageUrl="") {
  currentEditId = postId;
  oldImageUrl = imageUrl;

  modalTitle.value = title;
  modalContent.value = content;

  if(imageUrl) {
    modalPrevImg.src = imageUrl;
    modalPrevImg.classList.remove("hidden");
  } else {
    modalPrevImg.classList.add("hidden");
  }

  editModal.classList.remove("hidden");

  // Animate in
  setTimeout(() => {
    const modalBox = editModal.firstElementChild;
    modalBox.classList.remove("scale-75","opacity-0");
    modalBox.classList.add("scale-100","opacity-100");
  }, 10);
};

// Close modal
function closeModal() {
  const modalBox = editModal.firstElementChild;
  modalBox.classList.add("scale-75","opacity-0");
  setTimeout(() => {
    editModal.classList.add("hidden");
  }, 300);
}
modalCancelBtn.addEventListener("click", closeModal);

// Update post
modalUpdateBtn.addEventListener("click", async () => {
  const newTitle = modalTitle.value.trim();
  const newContent = modalContent.value.trim();
  const file = modalImage.files[0];

  if(!newTitle || !newContent){
    alert("Title aur Content required hain");
    return;
  }

  let imageUrl = oldImageUrl;

  if(file){
    const fileName = `post-${Date.now()}-${file.name}`;
    const { error: uploadError } = await client.storage.from("post-images").upload(fileName, file, { upsert:true });
    if(uploadError) return alert(uploadError.message);
    const { data } = client.storage.from("post-images").getPublicUrl(fileName);
    imageUrl = data.publicUrl;
  }

  const { error } = await client.from("posts").update({
    title:newTitle,
    content:newContent,
    image_url:imageUrl
  }).eq("id", currentEditId);

  if(error) return alert(error.message);

  fetchPosts();
  closeModal();
});

// Close modal if clicked outside
editModal.addEventListener("click", (e)=>{
  if(e.target === editModal) closeModal();
});




// ‚úÖ Delete post
async function deletePost(postId){
  const confirm = await Swal.fire({
    title:'Delete Post?',
    icon:'warning',
    showCancelButton:true,
    confirmButtonColor:'#d33',
    cancelButtonColor:'#3085d6',
    confirmButtonText:'Yes, delete it!'
  });
  if(confirm.isConfirmed){
    const { error } = await client.from("posts").delete()
      .eq("id", postId)
      .eq("user_id", currentUser.id);
    if(error) return Swal.fire({ icon:'error', title:'Oops!', text:error.message });
    Swal.fire({ icon:'success', title:'Deleted!', timer:1500, showConfirmButton:false });
    fetchPosts();
  }
}

// ‚úÖ Logout
logoutBtn.addEventListener("click", async ()=>{
  await client.auth.signOut();
  window.location.href="index.html";
});

// ‚úÖ Init
checkUser();
</script>

</body>
</html>
